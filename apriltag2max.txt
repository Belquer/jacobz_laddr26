# pip install pupil-apriltags opencv-python python-osc
import cv2, math
from pupil_apriltags import Detector
from pythonosc import udp_client

MAX_IP, MAX_PORT = "127.0.0.1", 8000
client = udp_client.SimpleUDPClient(MAX_IP, MAX_PORT)

cap = cv2.VideoCapture("http://<ESP_IP>:81/stream")  # or 0 for webcam

det = Detector(families="tag36h11", nthreads=2, refine_edges=True)

while True:
    ok, frame = cap.read()
    if not ok: continue
    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    results = det.detect(gray, estimate_tag_pose=False)
    for r in results:
        cx, cy = float(r.center[0]), float(r.center[1])
        # orientation from first two corners:
        (x0,y0),(x1,y1) = r.corners[0], r.corners[1]
        ang = math.degrees(math.atan2(y1-y0, x1-x0))
        client.send_message("/card", [int(r.tag_id), cx, cy, ang])